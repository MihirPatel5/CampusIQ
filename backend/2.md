# School ERP System - Part 2A: Database Design
## Complete ER Diagram & Schema Specification

**Version:** 1.0  
**Date:** December 31, 2024  
**Database:** PostgreSQL 14+

---

## Table of Contents

1. Database Overview
2. Entity Relationship Diagram (Textual)
3. Core Tables Schema
4. Relationships & Foreign Keys
5. Indexes & Performance
6. Data Integrity Rules

---

# 1. DATABASE OVERVIEW

## 1.1 Database Name
`school_erp_db`

## 1.2 Design Principles
- **Normalized:** 3NF (Third Normal Form) to avoid redundancy
- **Auditable:** All tables have `created_at`, `updated_at`, `created_by`, `updated_by`
- **Soft Deletes:** Critical tables use `is_deleted` flag instead of hard deletes
- **UUID Support:** Optional UUID fields for external integrations
- **Indexed:** All foreign keys and frequently queried fields are indexed

## 1.3 Naming Conventions
- **Tables:** Plural, snake_case (e.g., `school_profiles`, `student_profiles`)
- **Columns:** snake_case (e.g., `first_name`, `created_at`)
- **Foreign Keys:** `{table}_id` (e.g., `class_id`, `teacher_id`)
- **Primary Keys:** `id` (auto-increment integer)
- **Timestamps:** `created_at`, `updated_at` (datetime with timezone)

---

# 2. ENTITY RELATIONSHIP DIAGRAM (TEXTUAL)

## 2.1 Core Entities

```
┌─────────────────┐
│  school_profiles │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│     classes      │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│    sections      │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│ student_profiles │ (N)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│   attendance     │ (N)
└──────────────────┘

┌─────────────────┐
│     users        │ (1)
└────────┬────────┘
         │
         │ 1:1
         │
┌────────▼────────┐
│ teacher_profiles │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│  subject_assignments │ (N)
└────────┬─────────────┘
         │
         │ N:1
         │
┌────────▼────────┐
│    subjects      │ (1)
└──────────────────┘

┌─────────────────┐
│ student_profiles │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│  parent_profiles │ (N)
└──────────────────┘

┌─────────────────┐
│ fee_structures   │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│   fee_items      │ (N)
└──────────────────┘

┌─────────────────┐
│ student_profiles │ (1)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│    invoices      │ (N)
└────────┬────────┘
         │
         │ 1:N
         │
┌────────▼────────┐
│    payments      │ (N)
└──────────────────┘
```

---

# 3. CORE TABLES SCHEMA

## 3.1 Authentication & User Management

### 3.1.1 `users` Table
**Purpose:** Central user authentication table (Django's built-in User model extended)

```sql
CREATE TABLE users (
    id SERIAL PRIMARY KEY,
    username VARCHAR(150) UNIQUE NOT NULL,
    email VARCHAR(255) UNIQUE NOT NULL,
    password VARCHAR(128) NOT NULL,  -- Hashed
    first_name VARCHAR(100),
    last_name VARCHAR(100),
    is_active BOOLEAN DEFAULT TRUE,
    is_staff BOOLEAN DEFAULT FALSE,
    is_superuser BOOLEAN DEFAULT FALSE,
    role VARCHAR(20) NOT NULL,  -- 'admin', 'teacher', 'student', 'parent'
    last_login TIMESTAMP WITH TIME ZONE,
    date_joined TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_users_email ON users(email);
CREATE INDEX idx_users_username ON users(username);
CREATE INDEX idx_users_role ON users(role);
CREATE INDEX idx_users_is_active ON users(is_active);
```

**Fields:**
- `id`: Primary key
- `username`: Unique username for login
- `email`: Unique email address
- `password`: Hashed password (Django's PBKDF2)
- `role`: User role (admin/teacher/student/parent)
- `is_active`: Soft delete flag
- `created_by_id`, `updated_by_id`: Audit trail

### 3.1.2 `school_profiles` Table
**Purpose:** School information and settings

```sql
CREATE TABLE school_profiles (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,
    logo VARCHAR(500),  -- File path/URL
    address TEXT,
    phone VARCHAR(20),
    email VARCHAR(255),
    website VARCHAR(255),
    established_year INTEGER,
    affiliation VARCHAR(100),  -- e.g., "CBSE", "ICSE"
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_by_id INTEGER REFERENCES users(id)
);

-- Only one school profile allowed
CREATE UNIQUE INDEX idx_school_profiles_single ON school_profiles((1));
```

**Fields:**
- `name`: School name (appears everywhere)
- `logo`: Logo file path/URL
- `affiliation`: Board affiliation

### 3.1.3 `teacher_profiles` Table
**Purpose:** Extended teacher information

```sql
CREATE TABLE teacher_profiles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE NOT NULL REFERENCES users(id) ON DELETE CASCADE,
    employee_id VARCHAR(50) UNIQUE,
    phone VARCHAR(20) UNIQUE NOT NULL,
    date_of_birth DATE,
    joining_date DATE NOT NULL,
    qualification TEXT,
    specialization VARCHAR(200),
    address TEXT,
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'inactive', 'resigned'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_teacher_profiles_user_id ON teacher_profiles(user_id);
CREATE INDEX idx_teacher_profiles_employee_id ON teacher_profiles(employee_id);
CREATE INDEX idx_teacher_profiles_status ON teacher_profiles(status);
```

**Fields:**
- `user_id`: One-to-one with users table
- `employee_id`: Unique employee ID
- `status`: Teacher status

---

## 3.2 Academic Structure

### 3.2.1 `classes` Table
**Purpose:** Class definitions (Class 1, Class 10, etc.)

```sql
CREATE TABLE classes (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,  -- e.g., "Class 10"
    code VARCHAR(20) UNIQUE NOT NULL,  -- e.g., "C10"
    academic_year VARCHAR(10) NOT NULL,  -- e.g., "2024-25"
    description TEXT,
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'inactive'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_classes_code ON classes(code);
CREATE INDEX idx_classes_academic_year ON classes(academic_year);
CREATE INDEX idx_classes_status ON classes(status);
```

**Fields:**
- `code`: Unique class code (C1, C10, etc.)
- `academic_year`: Academic year (YYYY-YY format)

### 3.2.2 `sections` Table
**Purpose:** Sections within classes (A, B, Science, etc.)

```sql
CREATE TABLE sections (
    id SERIAL PRIMARY KEY,
    class_id INTEGER NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
    name VARCHAR(50) NOT NULL,  -- e.g., "A", "B", "Science"
    code VARCHAR(20) NOT NULL,  -- e.g., "10-A", "10-B"
    capacity INTEGER,  -- Max students
    room_number VARCHAR(20),
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id),
    UNIQUE(class_id, code)  -- Unique code within class
);

CREATE INDEX idx_sections_class_id ON sections(class_id);
CREATE INDEX idx_sections_code ON sections(code);
CREATE INDEX idx_sections_status ON sections(status);
```

**Fields:**
- `class_id`: Foreign key to classes
- `code`: Unique within class (e.g., "10-A")
- `capacity`: Maximum students allowed

### 3.2.3 `subjects` Table
**Purpose:** Subject definitions (Mathematics, Physics, etc.)

```sql
CREATE TABLE subjects (
    id SERIAL PRIMARY KEY,
    name VARCHAR(100) NOT NULL,  -- e.g., "Mathematics"
    code VARCHAR(20) UNIQUE NOT NULL,  -- e.g., "MATH"
    type VARCHAR(20) NOT NULL,  -- 'core', 'elective', 'optional'
    description TEXT,
    max_marks INTEGER DEFAULT 100,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_subjects_code ON subjects(code);
CREATE INDEX idx_subjects_type ON subjects(type);
CREATE INDEX idx_subjects_status ON subjects(status);
```

**Fields:**
- `code`: Unique subject code (MATH, PHY, etc.)
- `type`: Subject type (core/elective/optional)
- `max_marks`: Default maximum marks for exams

### 3.2.4 `subject_assignments` Table
**Purpose:** Assign subjects to class+section with teacher

```sql
CREATE TABLE subject_assignments (
    id SERIAL PRIMARY KEY,
    class_id INTEGER NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
    section_id INTEGER NOT NULL REFERENCES sections(id) ON DELETE CASCADE,
    subject_id INTEGER NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
    teacher_id INTEGER NOT NULL REFERENCES teacher_profiles(id) ON DELETE RESTRICT,
    academic_year VARCHAR(10) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id),
    UNIQUE(class_id, section_id, subject_id, academic_year)  -- No duplicate assignments
);

CREATE INDEX idx_subject_assignments_class_section ON subject_assignments(class_id, section_id);
CREATE INDEX idx_subject_assignments_teacher_id ON subject_assignments(teacher_id);
CREATE INDEX idx_subject_assignments_subject_id ON subject_assignments(subject_id);
CREATE INDEX idx_subject_assignments_academic_year ON subject_assignments(academic_year);
```

**Fields:**
- Links class, section, subject, and teacher
- Unique constraint prevents duplicate assignments

---

## 3.3 Student Management

### 3.3.1 `student_profiles` Table
**Purpose:** Extended student information

```sql
CREATE TABLE student_profiles (
    id SERIAL PRIMARY KEY,
    user_id INTEGER UNIQUE REFERENCES users(id) ON DELETE CASCADE,
    admission_number VARCHAR(50) UNIQUE NOT NULL,  -- e.g., "ADM2024001"
    first_name VARCHAR(100) NOT NULL,
    last_name VARCHAR(100) NOT NULL,
    date_of_birth DATE NOT NULL,
    gender VARCHAR(10) NOT NULL,  -- 'male', 'female', 'other'
    blood_group VARCHAR(5),
    aadhaar_number VARCHAR(12) UNIQUE,
    email VARCHAR(255) UNIQUE,
    phone VARCHAR(20) UNIQUE NOT NULL,
    address TEXT NOT NULL,
    city VARCHAR(100) NOT NULL,
    state VARCHAR(100) NOT NULL,
    pincode VARCHAR(10) NOT NULL,
    admission_date DATE NOT NULL,
    class_id INTEGER NOT NULL REFERENCES classes(id) ON DELETE RESTRICT,
    section_id INTEGER NOT NULL REFERENCES sections(id) ON DELETE RESTRICT,
    previous_school VARCHAR(200),
    previous_class VARCHAR(50),
    status VARCHAR(20) DEFAULT 'active',  -- 'active', 'inactive', 'graduated', 'transferred'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_student_profiles_admission_number ON student_profiles(admission_number);
CREATE INDEX idx_student_profiles_class_section ON student_profiles(class_id, section_id);
CREATE INDEX idx_student_profiles_email ON student_profiles(email);
CREATE INDEX idx_student_profiles_phone ON student_profiles(phone);
CREATE INDEX idx_student_profiles_status ON student_profiles(status);
```

**Fields:**
- `admission_number`: Unique admission number
- `aadhaar_number`: Optional, unique if provided
- `class_id`, `section_id`: Current class and section

### 3.3.2 `parent_profiles` Table
**Purpose:** Parent/Guardian information

```sql
CREATE TABLE parent_profiles (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
    relation VARCHAR(20) NOT NULL,  -- 'father', 'mother', 'guardian'
    name VARCHAR(100) NOT NULL,
    phone VARCHAR(20),
    email VARCHAR(255),
    occupation VARCHAR(100),
    address TEXT,
    is_primary BOOLEAN DEFAULT FALSE,  -- Primary contact
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_parent_profiles_student_id ON parent_profiles(student_id);
CREATE INDEX idx_parent_profiles_relation ON parent_profiles(relation);
```

**Fields:**
- `student_id`: Links to student
- `relation`: Father/Mother/Guardian
- `is_primary`: Primary contact for communications

---

## 3.4 Attendance Module

### 3.4.1 `attendance` Table
**Purpose:** Daily attendance records

```sql
CREATE TABLE attendance (
    id SERIAL PRIMARY KEY,
    student_id INTEGER NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
    class_id INTEGER NOT NULL REFERENCES classes(id) ON DELETE CASCADE,
    section_id INTEGER NOT NULL REFERENCES sections(id) ON DELETE CASCADE,
    date DATE NOT NULL,
    status VARCHAR(20) NOT NULL,  -- 'present', 'absent', 'late', 'leave'
    remarks TEXT,
    marked_by_id INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_by_id INTEGER REFERENCES users(id),
    UNIQUE(student_id, date)  -- One record per student per day
);

CREATE INDEX idx_attendance_student_id ON attendance(student_id);
CREATE INDEX idx_attendance_date ON attendance(date);
CREATE INDEX idx_attendance_class_section ON attendance(class_id, section_id);
CREATE INDEX idx_attendance_date_range ON attendance(date, class_id, section_id);
```

**Fields:**
- `date`: Attendance date
- `status`: Present/Absent/Late/Leave
- `marked_by_id`: Teacher who marked attendance
- Unique constraint: One record per student per day

---

## 3.5 Fee Management Module

### 3.5.1 `fee_structures` Table
**Purpose:** Fee structure definitions

```sql
CREATE TABLE fee_structures (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,  -- e.g., "Class 10 Annual Fee 2024-25"
    academic_year VARCHAR(10) NOT NULL,
    class_id INTEGER REFERENCES classes(id) ON DELETE RESTRICT,  -- NULL = applicable to all classes
    total_amount DECIMAL(10, 2) NOT NULL,
    status VARCHAR(20) DEFAULT 'active',
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_fee_structures_class_id ON fee_structures(class_id);
CREATE INDEX idx_fee_structures_academic_year ON fee_structures(academic_year);
CREATE INDEX idx_fee_structures_status ON fee_structures(status);
```

**Fields:**
- `class_id`: NULL = applicable to all classes, or specific class
- `total_amount`: Sum of all fee items

### 3.5.2 `fee_items` Table
**Purpose:** Individual fee items within a structure

```sql
CREATE TABLE fee_items (
    id SERIAL PRIMARY KEY,
    fee_structure_id INTEGER NOT NULL REFERENCES fee_structures(id) ON DELETE CASCADE,
    name VARCHAR(200) NOT NULL,  -- e.g., "Tuition Fee", "Library Fee"
    amount DECIMAL(10, 2) NOT NULL,
    due_date DATE NOT NULL,
    installment INTEGER DEFAULT 1,  -- Installment number
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_fee_items_fee_structure_id ON fee_items(fee_structure_id);
CREATE INDEX idx_fee_items_due_date ON fee_items(due_date);
```

**Fields:**
- `fee_structure_id`: Parent fee structure
- `installment`: Installment number (1, 2, 3, etc.)

### 3.5.3 `invoices` Table
**Purpose:** Fee invoices for students

```sql
CREATE TABLE invoices (
    id SERIAL PRIMARY KEY,
    invoice_number VARCHAR(50) UNIQUE NOT NULL,  -- e.g., "INV-2024-001"
    student_id INTEGER NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
    fee_structure_id INTEGER NOT NULL REFERENCES fee_structures(id) ON DELETE RESTRICT,
    total_amount DECIMAL(10, 2) NOT NULL,
    paid_amount DECIMAL(10, 2) DEFAULT 0.00,
    remaining_amount DECIMAL(10, 2) NOT NULL,
    due_date DATE NOT NULL,
    status VARCHAR(20) DEFAULT 'pending',  -- 'pending', 'partial', 'paid', 'overdue'
    installment INTEGER DEFAULT 1,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_invoices_student_id ON invoices(student_id);
CREATE INDEX idx_invoices_invoice_number ON invoices(invoice_number);
CREATE INDEX idx_invoices_status ON invoices(status);
CREATE INDEX idx_invoices_due_date ON invoices(due_date);
```

**Fields:**
- `invoice_number`: Unique invoice number (auto-generated)
- `status`: Payment status
- `paid_amount`, `remaining_amount`: Calculated fields

### 3.5.4 `payments` Table
**Purpose:** Fee payment records

```sql
CREATE TABLE payments (
    id SERIAL PRIMARY KEY,
    invoice_id INTEGER NOT NULL REFERENCES invoices(id) ON DELETE CASCADE,
    receipt_number VARCHAR(50) UNIQUE NOT NULL,  -- e.g., "RCP-2024-001"
    amount DECIMAL(10, 2) NOT NULL,
    payment_date DATE NOT NULL,
    payment_mode VARCHAR(20) NOT NULL,  -- 'cash', 'cheque', 'online', 'bank_transfer'
    transaction_reference VARCHAR(100),  -- For online/bank payments
    remarks TEXT,
    created_by_id INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_payments_invoice_id ON payments(invoice_id);
CREATE INDEX idx_payments_receipt_number ON payments(receipt_number);
CREATE INDEX idx_payments_payment_date ON payments(payment_date);
CREATE INDEX idx_payments_payment_mode ON payments(payment_mode);
```

**Fields:**
- `receipt_number`: Unique receipt number (auto-generated)
- `payment_mode`: Payment method
- `transaction_reference`: For online/bank transactions

---

## 3.6 Exam Module (Milestone 3)

### 3.6.1 `exams` Table
**Purpose:** Exam definitions

```sql
CREATE TABLE exams (
    id SERIAL PRIMARY KEY,
    name VARCHAR(200) NOT NULL,  -- e.g., "Mid-Term Exam 2024"
    exam_type VARCHAR(50) NOT NULL,  -- 'unit_test', 'mid_term', 'final', 'annual'
    academic_year VARCHAR(10) NOT NULL,
    start_date DATE,
    end_date DATE,
    status VARCHAR(20) DEFAULT 'draft',  -- 'draft', 'active', 'completed', 'published'
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    created_by_id INTEGER REFERENCES users(id),
    updated_by_id INTEGER REFERENCES users(id)
);

CREATE INDEX idx_exams_academic_year ON exams(academic_year);
CREATE INDEX idx_exams_status ON exams(status);
```

### 3.6.2 `exam_results` Table
**Purpose:** Student exam marks

```sql
CREATE TABLE exam_results (
    id SERIAL PRIMARY KEY,
    exam_id INTEGER NOT NULL REFERENCES exams(id) ON DELETE CASCADE,
    student_id INTEGER NOT NULL REFERENCES student_profiles(id) ON DELETE CASCADE,
    subject_id INTEGER NOT NULL REFERENCES subjects(id) ON DELETE CASCADE,
    marks_obtained DECIMAL(5, 2) NOT NULL,
    max_marks DECIMAL(5, 2) NOT NULL,
    grade VARCHAR(5),  -- 'A+', 'A', 'B+', etc.
    remarks TEXT,
    entered_by_id INTEGER NOT NULL REFERENCES users(id),
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    updated_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP,
    UNIQUE(exam_id, student_id, subject_id)  -- One result per exam+student+subject
);

CREATE INDEX idx_exam_results_exam_id ON exam_results(exam_id);
CREATE INDEX idx_exam_results_student_id ON exam_results(student_id);
CREATE INDEX idx_exam_results_subject_id ON exam_results(subject_id);
```

---

## 3.7 Audit & Logging

### 3.7.1 `audit_logs` Table
**Purpose:** System-wide audit trail

```sql
CREATE TABLE audit_logs (
    id SERIAL PRIMARY KEY,
    user_id INTEGER REFERENCES users(id),
    action VARCHAR(50) NOT NULL,  -- 'create', 'update', 'delete', 'login', 'logout'
    model_name VARCHAR(100) NOT NULL,  -- Table/model name
    object_id INTEGER,  -- ID of affected object
    changes JSONB,  -- Before/after changes
    ip_address VARCHAR(45),
    user_agent TEXT,
    created_at TIMESTAMP WITH TIME ZONE DEFAULT CURRENT_TIMESTAMP
);

CREATE INDEX idx_audit_logs_user_id ON audit_logs(user_id);
CREATE INDEX idx_audit_logs_action ON audit_logs(action);
CREATE INDEX idx_audit_logs_model_name ON audit_logs(model_name);
CREATE INDEX idx_audit_logs_created_at ON audit_logs(created_at);
```

**Fields:**
- `changes`: JSONB field storing before/after values
- `ip_address`: User's IP address
- `user_agent`: Browser/client information

---

# 4. RELATIONSHIPS & FOREIGN KEYS

## 4.1 Relationship Summary

| Parent Table | Child Table | Relationship | Cascade |
|--------------|-------------|--------------|---------|
| `users` | `teacher_profiles` | 1:1 | CASCADE |
| `users` | `student_profiles` | 1:1 | CASCADE |
| `classes` | `sections` | 1:N | CASCADE |
| `classes` | `student_profiles` | 1:N | RESTRICT |
| `sections` | `student_profiles` | 1:N | RESTRICT |
| `classes` | `subject_assignments` | 1:N | CASCADE |
| `sections` | `subject_assignments` | 1:N | CASCADE |
| `subjects` | `subject_assignments` | 1:N | CASCADE |
| `teacher_profiles` | `subject_assignments` | 1:N | RESTRICT |
| `student_profiles` | `attendance` | 1:N | CASCADE |
| `student_profiles` | `parent_profiles` | 1:N | CASCADE |
| `student_profiles` | `invoices` | 1:N | CASCADE |
| `fee_structures` | `fee_items` | 1:N | CASCADE |
| `fee_structures` | `invoices` | 1:N | RESTRICT |
| `invoices` | `payments` | 1:N | CASCADE |
| `exams` | `exam_results` | 1:N | CASCADE |
| `student_profiles` | `exam_results` | 1:N | CASCADE |
| `subjects` | `exam_results` | 1:N | CASCADE |

## 4.2 Cascade Rules

- **CASCADE:** When parent is deleted, child records are deleted
  - Used for: sections (when class deleted), attendance (when student deleted)
  
- **RESTRICT:** Prevents deletion if child records exist
  - Used for: classes (if students exist), fee_structures (if invoices exist)

---

# 5. INDEXES & PERFORMANCE

## 5.1 Primary Indexes
- All primary keys are automatically indexed
- All foreign keys are indexed for join performance

## 5.2 Composite Indexes
- `(class_id, section_id)` on `student_profiles` - For class-wise queries
- `(class_id, section_id)` on `attendance` - For attendance queries
- `(date, class_id, section_id)` on `attendance` - For date range queries
- `(exam_id, student_id, subject_id)` on `exam_results` - For result queries

## 5.3 Query Optimization
- Frequently queried fields (status, academic_year, date) are indexed
- JSONB fields use GIN indexes for efficient JSON queries
- Full-text search indexes on name fields (future enhancement)

---

# 6. DATA INTEGRITY RULES

## 6.1 Unique Constraints
- `users.email` - Unique
- `users.username` - Unique
- `teacher_profiles.employee_id` - Unique (if provided)
- `student_profiles.admission_number` - Unique
- `student_profiles.aadhaar_number` - Unique (if provided)
- `sections.code` - Unique within class
- `subjects.code` - Unique
- `invoices.invoice_number` - Unique
- `payments.receipt_number` - Unique
- `(student_id, date)` on `attendance` - One record per student per day
- `(class_id, section_id, subject_id, academic_year)` on `subject_assignments` - No duplicate assignments

## 6.2 Check Constraints
- `attendance.status` IN ('present', 'absent', 'late', 'leave')
- `subjects.type` IN ('core', 'elective', 'optional')
- `invoices.status` IN ('pending', 'partial', 'paid', 'overdue')
- `payments.amount` > 0
- `invoices.paid_amount` <= `invoices.total_amount`

## 6.3 Default Values
- `status` fields default to 'active'
- `created_at`, `updated_at` default to CURRENT_TIMESTAMP
- `is_active` defaults to TRUE
- `max_marks` defaults to 100

---

**END OF PART 2A**

**Next:** See `SCHOOL_ERP_PROTOTYPE_PART2B_API.md` for Complete API Design



# School ERP System - Part 2B: Complete API Design
## RESTful API Endpoint Specifications

**Version:** 1.0  
**Date:** December 31, 2024  
**API Base URL:** `/api/v1/`  
**Authentication:** JWT Bearer Token

---

## Table of Contents

1. API Overview
2. Authentication APIs
3. School Profile APIs
4. User Management APIs
5. Academic Structure APIs
6. Student Management APIs
7. Attendance APIs
8. Fee Management APIs
9. Exam APIs (Milestone 3)
10. Report APIs
11. Error Handling

---

# 1. API OVERVIEW

## 1.1 Base URL
```
Production: https://api.school.com/api/v1/
Development: http://localhost:8000/api/v1/
```

## 1.2 Authentication
All APIs (except login/refresh) require JWT Bearer token:
```
Authorization: Bearer <access_token>
```

## 1.3 Response Format
**Success Response (200/201):**
```json
{
  "data": {...},
  "message": "Success message (optional)"
}
```

**Error Response (4xx/5xx):**
```json
{
  "error": "Error message",
  "details": {...}  // Field-level errors
}
```

## 1.4 Pagination
List endpoints support pagination:
```
GET /api/v1/students/?page=1&page_size=20
```

**Response:**
```json
{
  "count": 450,
  "next": "http://api.school.com/api/v1/students/?page=2",
  "previous": null,
  "results": [...]
}
```

---

# 2. AUTHENTICATION APIs

## 2.1 Login
**Endpoint:** `POST /api/v1/auth/login/`

**Request:**
```json
{
  "username": "admin@school.com",
  "password": "SecurePass123"
}
```

**Response (200):**
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc...",
  "user": {
    "id": 1,
    "username": "admin",
    "email": "admin@school.com",
    "role": "admin",
    "first_name": "Admin",
    "last_name": "User"
  }
}
```

**Error (401):**
```json
{
  "error": "No active account found with the given credentials"
}
```

---

## 2.2 Token Refresh
**Endpoint:** `POST /api/v1/auth/refresh/`

**Request:**
```json
{
  "refresh": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

**Response (200):**
```json
{
  "access": "eyJ0eXAiOiJKV1QiLCJhbGc..."
}
```

---

## 2.3 Logout
**Endpoint:** `POST /api/v1/auth/logout/`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200):**
```json
{
  "message": "Successfully logged out"
}
```

---

## 2.4 Get Current User
**Endpoint:** `GET /api/v1/auth/me/`

**Headers:**
```
Authorization: Bearer <access_token>
```

**Response (200):**
```json
{
  "id": 1,
  "username": "admin",
  "email": "admin@school.com",
  "role": "admin",
  "first_name": "Admin",
  "last_name": "User",
  "profile": {
    "employee_id": "A001",
    "phone": "+919876543210"
  }
}
```

---

# 3. SCHOOL PROFILE APIs

## 3.1 Get School Profile
**Endpoint:** `GET /api/v1/school/profile/`

**Response (200):**
```json
{
  "id": 1,
  "name": "ABC International School",
  "logo": "https://domain.com/media/school/logo.png",
  "address": "123 School Street, City",
  "phone": "+919876543210",
  "email": "info@school.com",
  "website": "https://school.com",
  "established_year": 1990,
  "affiliation": "CBSE",
  "updated_at": "2024-12-31T10:00:00Z"
}
```

---

## 3.2 Update School Profile
**Endpoint:** `PATCH /api/v1/school/profile/`

**Request (multipart/form-data):**
```
name: ABC International School
logo: <file>
address: 123 School Street, City
phone: +919876543210
email: info@school.com
```

**Response (200):**
```json
{
  "id": 1,
  "name": "ABC International School",
  "logo": "https://domain.com/media/school/logo.png",
  ...
}
```

**Validations:**
- Name: required, max 200 chars
- Logo: image file, max 2MB, formats: PNG/JPG/JPEG
- Email: valid email format

---

# 4. USER MANAGEMENT APIs

## 4.1 Create Teacher
**Endpoint:** `POST /api/v1/teachers/`

**Request:**
```json
{
  "first_name": "John",
  "last_name": "Doe",
  "email": "john.doe@school.com",
  "phone": "+919876543210",
  "employee_id": "T001",
  "date_of_birth": "1985-05-15",
  "joining_date": "2024-01-01",
  "qualification": "M.Sc. Physics",
  "address": "123 Main St, City",
  "password": "SecurePass123",
  "password_confirm": "SecurePass123"
}
```

**Response (201):**
```json
{
  "id": 5,
  "first_name": "John",
  "last_name": "Doe",
  "email": "john.doe@school.com",
  "employee_id": "T001",
  "phone": "+919876543210",
  "status": "active",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 4.2 List Teachers
**Endpoint:** `GET /api/v1/teachers/`

**Query Parameters:**
- `page`: Page number (default: 1)
- `page_size`: Items per page (default: 20)
- `status`: Filter by status (active/inactive)
- `search`: Search by name/email/employee_id

**Response (200):**
```json
{
  "count": 25,
  "next": "http://api.school.com/api/v1/teachers/?page=2",
  "previous": null,
  "results": [
    {
      "id": 5,
      "first_name": "John",
      "last_name": "Doe",
      "email": "john.doe@school.com",
      "employee_id": "T001",
      "status": "active"
    },
    ...
  ]
}
```

---

## 4.3 Get Teacher Details
**Endpoint:** `GET /api/v1/teachers/{id}/`

**Response (200):**
```json
{
  "id": 5,
  "first_name": "John",
  "last_name": "Doe",
  "email": "john.doe@school.com",
  "employee_id": "T001",
  "phone": "+919876543210",
  "date_of_birth": "1985-05-15",
  "joining_date": "2024-01-01",
  "qualification": "M.Sc. Physics",
  "address": "123 Main St, City",
  "status": "active",
  "assignments": [
    {
      "id": 50,
      "class": {"id": 10, "name": "Class 10"},
      "section": {"id": 25, "name": "A"},
      "subject": {"id": 15, "name": "Mathematics"}
    }
  ],
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 4.4 Update Teacher
**Endpoint:** `PATCH /api/v1/teachers/{id}/`

**Request:**
```json
{
  "phone": "+919876543211",
  "qualification": "M.Sc. Physics, Ph.D."
}
```

**Response (200):** Updated teacher object

---

## 4.5 Deactivate Teacher
**Endpoint:** `DELETE /api/v1/teachers/{id}/`

**Response (204):** No content

**Note:** Soft delete - sets `status` to 'inactive'

---

# 5. ACADEMIC STRUCTURE APIs

## 5.1 Classes

### 5.1.1 Create Class
**Endpoint:** `POST /api/v1/classes/`

**Request:**
```json
{
  "name": "Class 10",
  "code": "C10",
  "academic_year": "2024-25",
  "description": "Secondary School Class 10"
}
```

**Response (201):**
```json
{
  "id": 10,
  "name": "Class 10",
  "code": "C10",
  "academic_year": "2024-25",
  "description": "Secondary School Class 10",
  "status": "active",
  "student_count": 0,
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 5.1.2 List Classes
**Endpoint:** `GET /api/v1/classes/`

**Query Parameters:**
- `academic_year`: Filter by academic year
- `status`: Filter by status

**Response (200):** Paginated list of classes

---

### 5.1.3 Get Class Details
**Endpoint:** `GET /api/v1/classes/{id}/`

**Response (200):**
```json
{
  "id": 10,
  "name": "Class 10",
  "code": "C10",
  "academic_year": "2024-25",
  "sections": [
    {"id": 25, "name": "A", "code": "10-A", "student_count": 35},
    {"id": 26, "name": "B", "code": "10-B", "student_count": 32}
  ],
  "student_count": 67,
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 5.2 Sections

### 5.2.1 Create Section
**Endpoint:** `POST /api/v1/sections/`

**Request:**
```json
{
  "name": "A",
  "code": "10-A",
  "class_id": 10,
  "capacity": 40,
  "room_number": "101"
}
```

**Response (201):**
```json
{
  "id": 25,
  "name": "A",
  "code": "10-A",
  "class": {
    "id": 10,
    "name": "Class 10"
  },
  "capacity": 40,
  "room_number": "101",
  "current_strength": 0,
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 5.2.2 List Sections
**Endpoint:** `GET /api/v1/sections/`

**Query Parameters:**
- `class_id`: Filter by class
- `status`: Filter by status

**Response (200):** Paginated list of sections

---

## 5.3 Subjects

### 5.3.1 Create Subject
**Endpoint:** `POST /api/v1/subjects/`

**Request:**
```json
{
  "name": "Mathematics",
  "code": "MATH",
  "type": "core",
  "description": "Mathematics for Class 10",
  "max_marks": 100
}
```

**Response (201):**
```json
{
  "id": 15,
  "name": "Mathematics",
  "code": "MATH",
  "type": "core",
  "max_marks": 100,
  "status": "active",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 5.3.2 List Subjects
**Endpoint:** `GET /api/v1/subjects/`

**Query Parameters:**
- `type`: Filter by type (core/elective/optional)
- `status`: Filter by status

**Response (200):** Paginated list of subjects

---

## 5.4 Subject Assignments

### 5.4.1 Create Assignment
**Endpoint:** `POST /api/v1/assignments/`

**Request:**
```json
{
  "class_id": 10,
  "section_id": 25,
  "subject_id": 15,
  "teacher_id": 5,
  "academic_year": "2024-25"
}
```

**Response (201):**
```json
{
  "id": 50,
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A", "code": "10-A"},
  "subject": {"id": 15, "name": "Mathematics", "code": "MATH"},
  "teacher": {"id": 5, "name": "John Doe"},
  "academic_year": "2024-25",
  "status": "active",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 5.4.2 List Assignments
**Endpoint:** `GET /api/v1/assignments/`

**Query Parameters:**
- `class_id`: Filter by class
- `section_id`: Filter by section
- `teacher_id`: Filter by teacher
- `subject_id`: Filter by subject
- `academic_year`: Filter by academic year

**Response (200):** Paginated list of assignments

---

### 5.4.3 Get Teacher Assignments
**Endpoint:** `GET /api/v1/teachers/{id}/assignments/`

**Response (200):**
```json
{
  "teacher": {
    "id": 5,
    "name": "John Doe"
  },
  "assignments": [
    {
      "id": 50,
      "class": {"id": 10, "name": "Class 10"},
      "section": {"id": 25, "name": "A"},
      "subject": {"id": 15, "name": "Mathematics"},
      "academic_year": "2024-25"
    }
  ]
}
```

---

# 6. STUDENT MANAGEMENT APIs

## 6.1 Create Student
**Endpoint:** `POST /api/v1/students/`

**Request:**
```json
{
  "first_name": "Rahul",
  "last_name": "Sharma",
  "date_of_birth": "2010-05-15",
  "gender": "male",
  "blood_group": "O+",
  "aadhaar_number": "123456789012",
  "email": "rahul.sharma@email.com",
  "phone": "+919876543210",
  "address": "123 Main St",
  "city": "Mumbai",
  "state": "Maharashtra",
  "pincode": "400001",
  "admission_number": "ADM2024001",
  "admission_date": "2024-04-01",
  "class_id": 10,
  "section_id": 25,
  "previous_school": "XYZ School",
  "father_name": "Rajesh Sharma",
  "father_phone": "+919876543211",
  "father_email": "rajesh@email.com",
  "mother_name": "Priya Sharma",
  "mother_phone": "+919876543212",
  "mother_email": "priya@email.com"
}
```

**Response (201):**
```json
{
  "id": 100,
  "admission_number": "ADM2024001",
  "first_name": "Rahul",
  "last_name": "Sharma",
  "full_name": "Rahul Sharma",
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A", "code": "10-A"},
  "status": "active",
  "admission_date": "2024-04-01",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 6.2 List Students
**Endpoint:** `GET /api/v1/students/`

**Query Parameters:**
- `class_id`: Filter by class
- `section_id`: Filter by section
- `status`: Filter by status
- `search`: Search by name/admission_number/phone
- `page`: Page number
- `page_size`: Items per page

**Response (200):** Paginated list of students

---

## 6.3 Get Student Details
**Endpoint:** `GET /api/v1/students/{id}/`

**Response (200):**
```json
{
  "id": 100,
  "admission_number": "ADM2024001",
  "first_name": "Rahul",
  "last_name": "Sharma",
  "full_name": "Rahul Sharma",
  "date_of_birth": "2010-05-15",
  "gender": "male",
  "blood_group": "O+",
  "email": "rahul.sharma@email.com",
  "phone": "+919876543210",
  "address": "123 Main St",
  "city": "Mumbai",
  "state": "Maharashtra",
  "pincode": "400001",
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A", "code": "10-A"},
  "parents": [
    {
      "relation": "father",
      "name": "Rajesh Sharma",
      "phone": "+919876543211",
      "email": "rajesh@email.com"
    },
    {
      "relation": "mother",
      "name": "Priya Sharma",
      "phone": "+919876543212",
      "email": "priya@email.com"
    }
  ],
  "status": "active",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 6.4 Update Student
**Endpoint:** `PATCH /api/v1/students/{id}/`

**Request:**
```json
{
  "phone": "+919876543211",
  "address": "456 New St"
}
```

**Response (200):** Updated student object

---

# 7. ATTENDANCE APIs

## 7.1 Get Students for Marking Attendance
**Endpoint:** `GET /api/v1/attendance/mark/`

**Query Parameters:**
- `class_id`: Required
- `section_id`: Required
- `date`: Required (YYYY-MM-DD format)

**Response (200):**
```json
{
  "date": "2024-12-31",
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A"},
  "students": [
    {
      "id": 100,
      "admission_number": "ADM2024001",
      "name": "Rahul Sharma",
      "status": null,
      "previous_status": "present"
    },
    ...
  ],
  "already_marked": false
}
```

---

## 7.2 Mark Attendance
**Endpoint:** `POST /api/v1/attendance/mark/`

**Request:**
```json
{
  "date": "2024-12-31",
  "class_id": 10,
  "section_id": 25,
  "attendance": [
    {
      "student_id": 100,
      "status": "present"
    },
    {
      "student_id": 101,
      "status": "absent",
      "remarks": "Sick"
    },
    {
      "student_id": 102,
      "status": "late",
      "remarks": "Traffic"
    }
  ]
}
```

**Response (201):**
```json
{
  "success": true,
  "marked_count": 35,
  "date": "2024-12-31",
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A"},
  "attendance_summary": {
    "present": 30,
    "absent": 3,
    "late": 2,
    "leave": 0
  }
}
```

---

## 7.3 List Attendance Records
**Endpoint:** `GET /api/v1/attendance/`

**Query Parameters:**
- `student_id`: Filter by student
- `class_id`: Filter by class
- `section_id`: Filter by section
- `date`: Filter by date
- `date_from`: Filter from date
- `date_to`: Filter to date
- `status`: Filter by status

**Response (200):** Paginated list of attendance records

---

## 7.4 Get Student Attendance History
**Endpoint:** `GET /api/v1/attendance/student/{student_id}/`

**Query Parameters:**
- `date_from`: Start date
- `date_to`: End date

**Response (200):**
```json
{
  "student": {
    "id": 100,
    "name": "Rahul Sharma",
    "admission_number": "ADM2024001"
  },
  "attendance": [
    {
      "date": "2024-12-31",
      "status": "present",
      "remarks": null
    },
    ...
  ],
  "summary": {
    "total_days": 180,
    "present": 165,
    "absent": 10,
    "late": 5,
    "leave": 0,
    "attendance_percentage": 91.67
  }
}
```

---

## 7.5 Update Attendance
**Endpoint:** `PATCH /api/v1/attendance/{id}/`

**Request:**
```json
{
  "status": "present",
  "remarks": "Updated"
}
```

**Response (200):** Updated attendance record

**Note:** Can only update attendance on the same day

---

## 7.6 Get Attendance Statistics
**Endpoint:** `GET /api/v1/attendance/stats/`

**Query Parameters:**
- `class_id`: Required
- `section_id`: Optional
- `date_from`: Start date
- `date_to`: End date

**Response (200):**
```json
{
  "class": {"id": 10, "name": "Class 10"},
  "section": {"id": 25, "name": "A"},
  "date_from": "2024-04-01",
  "date_to": "2024-12-31",
  "total_students": 35,
  "average_attendance": 92.5,
  "student_stats": [
    {
      "student_id": 100,
      "name": "Rahul Sharma",
      "attendance_percentage": 95.0,
      "present": 171,
      "absent": 9
    },
    ...
  ]
}
```

---

# 8. FEE MANAGEMENT APIs

## 8.1 Fee Structures

### 8.1.1 Create Fee Structure
**Endpoint:** `POST /api/v1/fees/structures/`

**Request:**
```json
{
  "name": "Class 10 Annual Fee 2024-25",
  "academic_year": "2024-25",
  "class_id": 10,
  "fee_items": [
    {
      "name": "Tuition Fee",
      "amount": 50000,
      "due_date": "2024-04-15",
      "installment": 1
    },
    {
      "name": "Tuition Fee",
      "amount": 50000,
      "due_date": "2024-07-15",
      "installment": 2
    },
    {
      "name": "Library Fee",
      "amount": 2000,
      "due_date": "2024-04-15",
      "installment": 1
    }
  ]
}
```

**Response (201):**
```json
{
  "id": 5,
  "name": "Class 10 Annual Fee 2024-25",
  "academic_year": "2024-25",
  "class": {"id": 10, "name": "Class 10"},
  "total_amount": 102000.00,
  "fee_items": [
    {
      "id": 20,
      "name": "Tuition Fee",
      "amount": 50000.00,
      "due_date": "2024-04-15",
      "installment": 1
    },
    ...
  ],
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 8.1.2 List Fee Structures
**Endpoint:** `GET /api/v1/fees/structures/`

**Query Parameters:**
- `class_id`: Filter by class
- `academic_year`: Filter by academic year
- `status`: Filter by status

**Response (200):** Paginated list of fee structures

---

## 8.2 Invoices

### 8.2.1 Generate Invoices
**Endpoint:** `POST /api/v1/fees/invoices/generate/`

**Request (Individual):**
```json
{
  "fee_structure_id": 5,
  "student_ids": [100, 101, 102]
}
```

**Request (Bulk):**
```json
{
  "fee_structure_id": 5,
  "class_id": 10,
  "section_id": 25
}
```

**Response (201):**
```json
{
  "success": true,
  "invoices_created": 3,
  "invoices": [
    {
      "id": 50,
      "invoice_number": "INV-2024-001",
      "student": {"id": 100, "name": "Rahul Sharma"},
      "total_amount": 102000.00,
      "due_date": "2024-04-15",
      "status": "pending"
    },
    ...
  ]
}
```

---

### 8.2.2 List Invoices
**Endpoint:** `GET /api/v1/fees/invoices/`

**Query Parameters:**
- `student_id`: Filter by student
- `status`: Filter by status (pending/partial/paid/overdue)
- `due_date_from`: Filter from due date
- `due_date_to`: Filter to due date
- `invoice_number`: Search by invoice number

**Response (200):** Paginated list of invoices

---

### 8.2.3 Get Invoice Details
**Endpoint:** `GET /api/v1/fees/invoices/{id}/`

**Response (200):**
```json
{
  "id": 50,
  "invoice_number": "INV-2024-001",
  "student": {
    "id": 100,
    "admission_number": "ADM2024001",
    "name": "Rahul Sharma"
  },
  "fee_structure": {
    "id": 5,
    "name": "Class 10 Annual Fee 2024-25"
  },
  "fee_items": [
    {
      "name": "Tuition Fee",
      "amount": 50000.00,
      "due_date": "2024-04-15",
      "installment": 1
    },
    ...
  ],
  "total_amount": 102000.00,
  "paid_amount": 55000.00,
  "remaining_amount": 47000.00,
  "due_date": "2024-04-15",
  "status": "partial",
  "payments": [
    {
      "id": 200,
      "receipt_number": "RCP-2024-001",
      "amount": 55000.00,
      "payment_date": "2024-04-10",
      "payment_mode": "online"
    }
  ],
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 8.3 Payments

### 8.3.1 Record Payment
**Endpoint:** `POST /api/v1/fees/payments/`

**Request:**
```json
{
  "invoice_id": 50,
  "amount": 55000,
  "payment_date": "2024-04-10",
  "payment_mode": "online",
  "transaction_reference": "TXN123456789",
  "remarks": "Paid via UPI"
}
```

**Response (201):**
```json
{
  "id": 200,
  "invoice": {
    "id": 50,
    "invoice_number": "INV-2024-001",
    "status": "paid"
  },
  "receipt_number": "RCP-2024-001",
  "amount": 55000.00,
  "payment_date": "2024-04-10",
  "payment_mode": "online",
  "transaction_reference": "TXN123456789",
  "remarks": "Paid via UPI",
  "created_by": {"id": 1, "name": "Admin User"},
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

### 8.3.2 List Payments
**Endpoint:** `GET /api/v1/fees/payments/`

**Query Parameters:**
- `invoice_id`: Filter by invoice
- `student_id`: Filter by student
- `payment_date_from`: Filter from date
- `payment_date_to`: Filter to date
- `payment_mode`: Filter by payment mode

**Response (200):** Paginated list of payments

---

### 8.3.3 Get Receipt
**Endpoint:** `GET /api/v1/fees/receipts/{payment_id}/`

**Response (200):**
```json
{
  "id": 200,
  "receipt_number": "RCP-2024-001",
  "invoice": {
    "invoice_number": "INV-2024-001",
    "student": {"name": "Rahul Sharma", "admission_number": "ADM2024001"}
  },
  "amount": 55000.00,
  "payment_date": "2024-04-10",
  "payment_mode": "online",
  "transaction_reference": "TXN123456789",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

# 9. EXAM APIs (MILESTONE 3)

## 9.1 Create Exam
**Endpoint:** `POST /api/v1/exams/`

**Request:**
```json
{
  "name": "Mid-Term Exam 2024",
  "exam_type": "mid_term",
  "academic_year": "2024-25",
  "start_date": "2024-09-01",
  "end_date": "2024-09-15"
}
```

**Response (201):**
```json
{
  "id": 10,
  "name": "Mid-Term Exam 2024",
  "exam_type": "mid_term",
  "academic_year": "2024-25",
  "start_date": "2024-09-01",
  "end_date": "2024-09-15",
  "status": "draft",
  "created_at": "2024-12-31T10:00:00Z"
}
```

---

## 9.2 Enter Exam Marks
**Endpoint:** `POST /api/v1/exams/{exam_id}/marks/`

**Request:**
```json
{
  "results": [
    {
      "student_id": 100,
      "subject_id": 15,
      "marks_obtained": 85.5,
      "max_marks": 100,
      "remarks": "Good performance"
    },
    {
      "student_id": 101,
      "subject_id": 15,
      "marks_obtained": 92.0,
      "max_marks": 100
    }
  ]
}
```

**Response (201):**
```json
{
  "success": true,
  "results_created": 2,
  "exam": {"id": 10, "name": "Mid-Term Exam 2024"}
}
```

---

## 9.3 Get Exam Results
**Endpoint:** `GET /api/v1/exams/{exam_id}/results/`

**Query Parameters:**
- `class_id`: Filter by class
- `section_id`: Filter by section
- `student_id`: Filter by student

**Response (200):**
```json
{
  "exam": {
    "id": 10,
    "name": "Mid-Term Exam 2024",
    "exam_type": "mid_term"
  },
  "results": [
    {
      "student": {"id": 100, "name": "Rahul Sharma"},
      "subject": {"id": 15, "name": "Mathematics"},
      "marks_obtained": 85.5,
      "max_marks": 100,
      "percentage": 85.5,
      "grade": "A"
    },
    ...
  ]
}
```

---

# 10. REPORT APIs

## 10.1 Dashboard APIs

### 10.1.1 Admin Dashboard
**Endpoint:** `GET /api/v1/dashboard/admin/`

**Response (200):**
```json
{
  "total_students": 450,
  "total_teachers": 25,
  "total_classes": 12,
  "today_attendance": {
    "present": 420,
    "absent": 30,
    "percentage": 93.3
  },
  "pending_fees": {
    "count": 45,
    "amount": 225000.00
  },
  "upcoming_exams": [
    {
      "id": 10,
      "name": "Mid-Term Exam 2024",
      "start_date": "2024-09-01"
    }
  ]
}
```

---

### 10.1.2 Teacher Dashboard
**Endpoint:** `GET /api/v1/dashboard/teacher/`

**Response (200):**
```json
{
  "assignments": [
    {
      "class": {"id": 10, "name": "Class 10"},
      "section": {"id": 25, "name": "A"},
      "subject": {"id": 15, "name": "Mathematics"},
      "student_count": 35
    }
  ],
  "today_attendance": {
    "marked": 2,
    "pending": 1
  },
  "pending_marks": 5,
  "upcoming_exams": [...]
}
```

---

### 10.1.3 Student Dashboard
**Endpoint:** `GET /api/v1/dashboard/student/`

**Response (200):**
```json
{
  "student": {
    "id": 100,
    "name": "Rahul Sharma",
    "class": "Class 10",
    "section": "A"
  },
  "attendance": {
    "total_days": 180,
    "present": 165,
    "percentage": 91.67
  },
  "pending_fees": {
    "count": 2,
    "amount": 47000.00
  },
  "recent_exams": [...]
}
```

---

## 10.2 Export Reports
**Endpoint:** `GET /api/v1/reports/export/`

**Query Parameters:**
- `type`: Report type (attendance/fees/exams)
- `format`: Export format (csv/excel/pdf)
- Additional filters based on report type

**Response (200):** File download

---

# 11. ERROR HANDLING

## 11.1 Error Response Format
```json
{
  "error": "Error message",
  "details": {
    "field_name": ["Field-specific error message"]
  },
  "code": "ERROR_CODE"
}
```

## 11.2 HTTP Status Codes
- `200 OK`: Success
- `201 Created`: Resource created
- `204 No Content`: Success with no content
- `400 Bad Request`: Validation error
- `401 Unauthorized`: Authentication required
- `403 Forbidden`: Insufficient permissions
- `404 Not Found`: Resource not found
- `500 Internal Server Error`: Server error

## 11.3 Common Error Codes
- `VALIDATION_ERROR`: Input validation failed
- `AUTHENTICATION_REQUIRED`: JWT token missing/invalid
- `PERMISSION_DENIED`: User lacks required permissions
- `RESOURCE_NOT_FOUND`: Requested resource doesn't exist
- `DUPLICATE_ENTRY`: Unique constraint violation
- `INVALID_DATE`: Date format/range error

---

**END OF PART 2B**

**Next:** See `SCHOOL_ERP_PROTOTYPE_PART2C_AI_DEPLOYMENT.md` for AI-Agent Readiness & Deployment Strategy

